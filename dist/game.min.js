kontra.init();const{drawText}=new DrawFont(kontra.context),{toggleMusic}=new GameMusic,CANVAS_WIDTH=kontra.canvas.width,CANVAS_HEIGHT=kontra.canvas.height,PLAYER_SIZE=20,PLAYER_COLOR='#3498db',ENEMY_COLOR='#e74c3c',COIN_COLOR='#f1c40f',TEXT_COLOR='#ecf0f1';let powerUpTimeout=null,powerUpInterval=null;const state={bestScore:localStorage.getItem('b.best')||0,score:0,gravity:0.9,speed:1,pui:0,muted:!1,freeze:!1},powerUps={ghost:{color:'#95a5a6',start(){state.speed*=2},end(){state.speed/=2}},sizeUp:{color:'#2ecc71',start(){const a=players.get('radius');players.set('radius',1.5*a),players.set('image',createImage(3*a))},end(){const a=players.get('radius');players.set('radius',a/1.5),players.set('image',createImage(2*(a/1.5)))}},breed:{color:PLAYER_COLOR},kill:{color:'#9b59b6'}},menuTexts=[['FLYING',35,63,90,'#37516a'],['BUBBLES',33,55,343,'#37516a'],['CODE . GAME DESIGN . MUSIC BY DOGAGENC',2,343,585,'rgba(255,255,255,0.25)'],['BUBBLES',5,433,95,TEXT_COLOR],['. SCORE UP',3,442,135,COIN_COLOR],['. DO NOT TOUCH',3,419,165,ENEMY_COLOR],['POWER-UPS',5,408,225,TEXT_COLOR],['. BREED',3,458,265,PLAYER_COLOR],['. SIZE UP',3,445,295,powerUps.sizeUp.color],['. GHOST MODE',3,425,325,powerUps.ghost.color],['. KILL EM ALL',3,423,355,powerUps.kill.color],['CONTROLS',5,421,415,TEXT_COLOR],['SPACE > PLAY',3,432,455,'rgba(255,255,255,0.7)'],['M > MUSIC ON/OFF',3,399,485,'rgba(255,255,255,0.7)']],applyPowerUp=a=>{const b={breed:()=>players.breed(),kill:()=>enemies.items=[]};if(b[a])return b[a]();let c=players.get('powerUp');c&&powerUps[c].end(),clearTimeout(powerUpTimeout),clearInterval(powerUpInterval),state.pui=0,c=powerUps[a],players.set('color',c.color),players.set('powerUp',a);c.start&&(c.start(),powerUpInterval=setInterval(()=>{state.pui++},1e3),powerUpTimeout=setTimeout(()=>{players.get('powerUp')!==a||(c.end(),players.set('color',PLAYER_COLOR),players.set('powerUp',null))},1e4))},createImage=(a,b)=>{const c=b||document.createElement('canvas'),d=c.getContext('2d');return d.filter='blur(3px)',d.drawImage(bubble,0,0,a,a),c},drawCircle=(a,b,c,d,e)=>{a.fillStyle=e,a.beginPath(),a.arc(b,c,d,0,2*Math.PI),a.fill()};function render(){drawCircle(this.context,this.x,this.y,this.radius,this.color),this.context.drawImage(this.image,this.x-this.radius,this.y-this.radius)}function collidesWith(a){const b=this.x-a.x,c=this.y-a.y,d=Math.sqrt(b*b+c*c);return d<this.radius+a.radius}function update(){this.advance();this.gravity&&(this.dy+=state.gravity*PLAYER_SIZE/this.radius/2,this.dy*=0.9,this.y-this.radius>CANVAS_HEIGHT?this.y=0:0>this.y+this.radius&&(this.y=CANVAS_HEIGHT+this.radius))}class SpriteGroup{constructor(a){this.opts=a,this.items=[]}createOne(){const a=Array.isArray(this.opts.size)?Math.max(Math.random()*this.opts.size[1],this.opts.size[0]):this.opts.size,b={radius:a/2,x:CANVAS_WIDTH,y:Math.random()*CANVAS_HEIGHT,dx:-this.opts.speed*state.speed,color:this.opts.color,image:createImage(a),gravity:this.opts.gravity,render,collidesWith,update};if(this.opts.powerUps&&Math.random()<this.opts.powerUpRate){const c=Math.floor(this.opts.powerUps.length*Math.random()),d=this.opts.powerUps[c],e=powerUps[d];b.color=e.color,b.powerUp=d}this.items.push(kontra.sprite(b))}render(){this.items.forEach(a=>a.render())}update(){this.items.forEach((a,b)=>{if(a.update(),a.dx=-this.opts.speed*state.speed,0>a.x+a.radius/2&&this.items.splice(b,1),!!this.opts.onColusion){const c=players.collidesWith(a);c.length&&this.opts.onColusion({item:a,idx:b,collPlayers:c})}}),Math.random()<this.opts.creationRate*state.speed&&this.createOne()}}class Players{constructor(a){this.opts=a,this.items=[],this.createOne()}createOne(a){let b=this.opts;a&&(b={...b,color:this.get('color'),radius:this.get('radius'),image:this.get('image'),powerUp:this.get('powerUp'),y:a}),this.items.push(kontra.sprite(b))}get(a){return this.items[0][a]}set(a,b){this.items.forEach(c=>c[a]=b)}render(){this.items.forEach(a=>a.render())}update(){this.items.forEach(a=>a.update())}breed(){const a=this.items.reduce((b,c)=>Math.max(c.y,b),0);this.createOne(a+6*this.get('radius')*-state.gravity)}collidesWith(a){return this.items.reduce((b,c,d)=>{return c.collidesWith(a)&&b.push({item:c,idx:d}),b},[])}}const score=kontra.sprite({render(){const a=20*(state.bestScore+'').length,b=state.playing||state.freeze?'rgba(0,0,0,.5)':'rgba(255,255,255,.5)',c=[[`SCORE: ${state.score}`,5,5,5,b],[`BEST: ${state.bestScore}`,5,905-a,5,b]];players.get('powerUp')&&11>state.pui&&c.push([`${10-state.pui}`,5,5,CANVAS_HEIGHT/2-12,players.get('color')]),c.forEach(d=>drawText(...d))}}),menu=kontra.sprite({width:CANVAS_WIDTH,height:CANVAS_HEIGHT,x:0,y:0,color:'#34495e',render(){this.draw(),menuTexts.forEach(a=>drawText(...a))}}),players=new Players({radius:PLAYER_SIZE/2,x:50,y:50,color:PLAYER_COLOR,image:createImage(PLAYER_SIZE),gravity:!0,powerUp:null,render,collidesWith,update}),enemies=new SpriteGroup({size:[30,100],color:ENEMY_COLOR,speed:6,gravity:!0,creationRate:0.02,onColusion({collPlayers:a}){'ghost'===players.get('powerUp')||a.forEach(b=>{1<players.items.length?players.items.splice(b.idx,1):(state.playing=!1,state.freeze=!0,setTimeout(()=>{state.freeze=!1,resetGame()},600))})}}),rewards=new SpriteGroup({size:30,color:COIN_COLOR,speed:5,creationRate:0.03,powerUps:['ghost','sizeUp','breed','kill'],powerUpRate:0.1,onColusion({item:a,idx:b}){state.score++,rewards.items.splice(b,1),0==state.score%10&&(state.speed+=0.2),a.powerUp&&applyPowerUp(a.powerUp)}}),resetGame=()=>{state.gravity=0.9,state.pui=0,state.speed=1,enemies.items=[],rewards.items=[],players.items=[],players.createOne(),state.bestScore=Math.max(state.score,state.bestScore),localStorage.setItem('b.best',state.bestScore),clearInterval(powerUpInterval)};kontra.keys.bind('space',()=>{return state.playing||state.freeze?void(state.gravity*=-1):(state.playing=!0,void(state.score=0))}),kontra.keys.bind('m',()=>toggleMusic());const loop=kontra.gameLoop({update(){state.playing&&(players.update(),enemies.update(),rewards.update())},render(){players.render(),enemies.render(),rewards.render(),state.playing||state.freeze||menu.render(),score.render()}});toggleMusic(),loop.start();
